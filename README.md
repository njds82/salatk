# Salatk (ุตูุงุชู) ๐

**Salatk** ูู ุชุทุจูู ููุจ ุชูุฏูู (PWA) ูุชูุงูู ููุฏู ุฅูู ูุณุงุนุฏุฉ ุงููุณูู ุนูู ุงููุญุงูุธุฉ ุนูู ุตููุงุชูุ ุชุชุจุน ุงููุถุงุกุ ูุจูุงุก ุนุงุฏุงุช ุฅูุฌุงุจูุฉ ูู ุฎูุงู ูุธุงู ุชุญููุฒู ุฐูู (Gamification). ูุนุชูุฏ ุงูุชุทุจูู ุนูู ุชูููุงุช ุญุฏูุซุฉ ูุถูุงู ุงููุฒุงููุฉ ุงููุญุธูุฉ ูุงูุนูู ุจููุงุกุฉ ุนุงููุฉ.

---

## ๐ ุงูููุฑุณ
1. [ุฎุงุฑุทุฉ ุงููููุงุช (File Map)](#-ุฎุงุฑุทุฉ-ุงููููุงุช-file-map)
2. [ุดุฑุญ ุงููููุงุช ูุงููุฏูุฑูู (Modules)](#-ุดุฑุญ-ุงููููุงุช-ูุงููุฏูุฑูู-modules)
3. [ูุงุนุฏุฉ ุงูุจูุงูุงุช (Database Schema)](#-ูุงุนุฏุฉ-ุงูุจูุงูุงุช-database-schema)
4. [ุงูุงุชุตุงูุงุช ูุงูุนูุงูุงุช (Connections & Relationships)](#-ุงูุงุชุตุงูุงุช-ูุงูุนูุงูุงุช)
5. [ุงููุชุบูุฑุงุช ูุงูุซูุงุจุช (Variables & Constants)](#-ุงููุชุบูุฑุงุช-ูุงูุซูุงุจุช)
6. [ุงููุธุงุฆู ูุงูุนูููุงุช (Functions & Processes)](#-ุงููุธุงุฆู-ูุงูุนูููุงุช)

---

## ๐ ุฎุงุฑุทุฉ ุงููููุงุช (File Map)

```text
/home/loid/code/salatk/
โโโ index.html              # ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ูููุทุฉ ุงูุฏุฎูู ููุชุทุจูู
โโโ styles.css              # ููู ุงูุชูุณููุงุช ุงูุฑุฆูุณู (CSS Variables, Themes)
โโโ sw.js                   # Service Worker ููุฅุดุนุงุฑุงุช ูุงูุนูู ูู ุงูุฎูููุฉ
โโโ verify_hijri.js         # ุณูุฑุจุช ูุณุชูู ููุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ ุงููุฌุฑู
โโโ assets/                 # ูุฌูุฏ ุงูุตูุฑ ูุงูุฃููููุงุช
โโโ components/             # ููููุงุช ุงููุงุฌูุฉ (Modals, Cards)
โโโ js/                     # ุงูููุฏ ุงููุตุฏุฑู ููุฌุงูุงุณูุฑูุจุช
    โโโ app.js              # ููุทุฉ ุงูุจุฏุงูุฉ ูุชุดุบูู ุงูุชุทุจูู (Initialization)
    โโโ auth-manager.js     # ุฅุฏุงุฑุฉ ุชุณุฌูู ุงูุฏุฎูู ูุงููุณุชุฎุฏููู
    โโโ prayer-manager.js   # ููุทู ุญุณุงุจ ุฃููุงุช ุงูุตูุงุฉ ูุงููููุน
    โโโ sync-manager.js     # ุฅุฏุงุฑุฉ ุงููุฒุงููุฉ ุงููุญุธูุฉ (Realtime)
    โโโ notification-manager.js # ุฅุฏุงุฑุฉ ุงูุชูุจููุงุช ูุงูุฅุดุนุงุฑุงุช
    โโโ data-manager.js     # (ููู ูุณุงุนุฏ ููุชุนุงูู ูุน ุงูุจูุงูุงุช - ุฅู ูุฌุฏ)
    โโโ date-utils.js       # ุฏูุงู ูุณุงุนุฏุฉ ููุชูุงุฑูุฎ (ูููุงุฏู/ูุฌุฑู)
    โโโ ui-helpers.js       # ุฏูุงู ูุณุงุนุฏุฉ ูููุงุฌูุฉ (Toast, Loading)
    โโโ db.js               # ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ (ุฅู ูุฌุฏุช)
    โโโ supabaseClient.js   # ุฅุนุฏุงุฏ ุงุชุตุงู Supabase
    โโโ i18n.js             # ููู ุงูุชุฑุฌูุฉ (ุงูุนุฑุจูุฉ/ุงููุฌูุฒูุฉ)
    โโโ services/           # ุฎุฏูุงุช ุงูุชุนุงูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช
    โ   โโโ prayer-service.js   # ุฎุฏูุฉ ุงูุตููุงุช (ุชุณุฌููุ ูุถุงุก)
    โ   โโโ points-service.js   # ุฎุฏูุฉ ุงูููุงุท (ุฅุถุงูุฉุ ุฌูุจ ุงููุฌููุน)
    โ   โโโ settings-service.js # ุฎุฏูุฉ ุงูุฅุนุฏุงุฏุงุช (ุซููุ ูุบุฉ)
    โ   โโโ habit-service.js    # ุฎุฏูุฉ ุงูุนุงุฏุงุช
    โ   โโโ migration-service.js # ุฎุฏูุฉ ุชุฑุญูู ุงูุจูุงูุงุช (ุฅู ูุฌุฏุช)
    โโโ pages/              # ููุทู ูู ุตูุญุฉ ูู ุงูุชุทุจูู
    โ   โโโ daily-prayers.js    # ุตูุญุฉ ุงูุตููุงุช ุงูููููุฉ
    โ   โโโ qada-prayers.js     # ุตูุญุฉ ูุถุงุก ุงูุตููุงุช
    โ   โโโ habits.js           # ุตูุญุฉ ุงูุนุงุฏุงุช
    โ   โโโ leaderboard.js      # ุตูุญุฉ ุงููุชุตุฏุฑูู
    โ   โโโ store.js            # ูุชุฌุฑ ุงูููุงุท ูุงูุซููุงุช
    โ   โโโ settings.js         # ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช
    โ   โโโ statistics.js       # ุตูุญุฉ ุงูุฅุญุตุงุฆูุงุช
    โ   โโโ challenge.js        # ุตูุญุฉ ุงูุชุญุฏูุงุช ูุงููุณุงุจูุงุช
    โโโ data/               # ูููุงุช ุงูุจูุงูุงุช ุงูุซุงุจุชุฉ
        โโโ questions.js        # ุฃุณุฆูุฉ ุงูุชุญุฏูุงุช
```

---

## ๐ ุดุฑุญ ุงููููุงุช ูุงููุฏูุฑูู (Modules)

### 1. **Managers (ุงููุฏูุฑูู)**
ูุณุคูููู ุนู ุงูููุทู ุงูุชุดุบููู ููุชุทุจูู ูุฑุจุท ุงูุฎุฏูุงุช ุจุงููุงุฌูุฉ.

- **`AuthManager` (`js/auth-manager.js`)**:
  - ูุฏูุฑ ุนูููุงุช ุงููุตุงุฏูุฉ (ุชุณุฌูู ุฏุฎูู/ุฎุฑูุฌ).
  - ูููู ุจุฅูุดุงุก "ุฅูููู ูููู" ูู ุงุณู ุงููุณุชุฎุฏู (`username@salatk.local`) ูุชุณููู ุงูุชุณุฌูู.
  - ูุญูุธ ุฌูุณุฉ ุงููุณุชุฎุฏู (`Session`) ููุชุญูู ูููุง ุนูุฏ ุจุฏุก ุงูุชุทุจูู.

- **`PrayerManager` (`js/prayer-manager.js`)**:
  - ุงููุณุคูู ุนู ุญุณุงุจ ููุงููุช ุงูุตูุงุฉ ูุญููุงู ุจุงุณุชุฎุฏุงู ููุชุจุฉ `Adhan.js`.
  - ูุฏูุฑ ุงููููุน ุงูุฌุบุฑุงูู (ุชููุงุฆู ุฃู ูุฏูู).
  - ูุญุชูู ุนูู `checkAndMarkMissedPrayers` ุงูุชู ุชุนูู ุจุดูู ุฏูุฑู ููุญุต ุงูุตููุงุช ุงููุงุฆุชุฉ ูุชุณุฌูููุง ุชููุงุฆูุงู.

- **`SyncManager` (`js/sync-manager.js`)**:
  - ูุฏูุฑ ุงูุงุชุตุงู ุงูููุฑู (Realtime) ูุน `Supabase`.
  - ูุณุชูุน ููุชุบููุฑุงุช ูู ุฌุฏุงูู (`prayer_records`, `points_history`) ููุญุฏุซ ุงููุงุฌูุฉ ููุฑุงู ุฏูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.

- **`NotificationManager` (`js/notification-manager.js`)**:
  - ูุทูุจ ุตูุงุญูุงุช ุงูุฅุดุนุงุฑุงุช.
  - ูุฌุฏูู ุงูุชูุจููุงุช ูุฃููุงุช ุงูุตูุงุฉ ุงููุงุฏูุฉ ุจุงุณุชุฎุฏุงู Service Worker ูุถูุงู ูุตูููุง ุญุชู ูู ูุงู ุงูุชุทุจูู ูุบููุงู.

### 2. **Services (ุงูุฎุฏูุงุช)**
ูุงุฌูุฉ ุงูุชุนุงูู ุงููุจุงุดุฑ ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช (CRUD Operations).

- **`PrayerService`**: ุฅุถุงูุฉ ุงูุตููุงุชุ ุชุญุฏูุซ ุญุงูุชูุง (ุฃุฏุงุก/ูุถุงุก)ุ ูุญุณุงุจ ุณูุณูุฉ ุงูุงูุชุฒุงู (Streak).
- **`PointsService`**: ุฅุฏุงุฑุฉ ุฑุตูุฏ ุงูููุงุทุ ุนุฑุถ ุงูุณุฌูุ ูุงูุชุญูู ูู ุงููุฌููุน ุงูููู.
- **`SettingsService`**: ุญูุธ ูุงุณุชุฑุฌุงุน ุฅุนุฏุงุฏุงุช ุงููุณุชุฎุฏู (ุงููุบุฉุ ุงููุฐูุจุ ุทุฑููุฉ ุงูุญุณุงุจ) ููุฒุงููุชูุง ุจูู ุงูุฃุฌูุฒุฉ.

---

## ๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช (Database Schema)

ูุนุชูุฏ ุงููุดุฑูุน ุนูู **Supabase (PostgreSQL)**. ูููุง ููู ุดุฑุญ ุงูุฌุฏุงูู:

### 1. `profiles` (ุงููุณุชุฎุฏููู)
- **`id`**: (UUID) ููุชุงุญ ุฃุณุงุณูุ ูุฑุชุจุท ุจู `auth.users`.
- **`username`**: ุงุณู ุงููุณุชุฎุฏู.
- **`full_name`**: ุงูุงุณู ุงููุงูู.
- **`referral_code`**: ููุฏ ุงูุฏุนูุฉ ุงูุฎุงุต ุจุงููุณุชุฎุฏู.
- **`referred_by`**: ููุฏ ุงูุดุฎุต ุงูุฐู ูุงู ุจุฏุนูุฉ ูุฐุง ุงููุณุชุฎุฏู.

### 2. `prayer_records` (ุณุฌู ุงูุตููุงุช)
- **`user_id`**: (Foreign Key) ูุนุฑู ุงููุณุชุฎุฏู.
- **`date`**: (Date) ุชุงุฑูุฎ ุงูููู (YYYY-MM-DD).
- **`prayer_key`**: (Text) ุงุณู ุงูุตูุงุฉ (`fajr`, `dhuhr`...).
- **`status`**: (Text) ุงูุญุงูุฉ (`done`, `missed`).
- **`recorded_at`**: ููุช ุงูุชุณุฌูู.
- *ููุฏ ูุฑูุฏ (Unique Constraint)*: ูุง ูููู ุชูุฑุงุฑ ููุณ ุงูุตูุงุฉ ูููุณ ุงููุณุชุฎุฏู ูู ููุณ ุงูุชุงุฑูุฎ.

### 3. `qada_prayers` (ุงูุตููุงุช ุงููุงุฆุชุฉ/ุงููุถุงุก)
- **`user_id`**: ูุนุฑู ุงููุณุชุฎุฏู.
- **`original_date`**: ุชุงุฑูุฎ ุงูุตูุงุฉ ุงูุฃุตููุฉ (ุฅู ูุฌุฏ).
- **`prayer_key`**: ุงูุตูุงุฉ ุงููุงุฆุชุฉ.
- **`rakaat`**: ุนุฏุฏ ุงูุฑูุนุงุช (ูููุณุงุนุฏุฉ ูู ุงูุชุฌููุน).
- **`is_manual`**: (Boolean) ูู ุชูุช ุฅุถุงูุชูุง ูุฏููุงู ุฃู ุชููุงุฆูุงูุ

### 4. `points_history` (ุณุฌู ุงูููุงุท)
- **`user_id`**: ูุนุฑู ุงููุณุชุฎุฏู.
- **`amount`**: ูููุฉ ุงูููุงุท (ููุฌุจุฉ ููุฅุถุงูุฉุ ุณุงูุจุฉ ููุฎุตู).
- **`reason`**: ุณุจุจ ุงูุนูููุฉ (ูุซูุงู: "ุตูุงุฉ ุงููุฌุฑ ุญุงุถุฑุงู").
- **`recorded_at`**: ููุช ุงูุนูููุฉ.

### 5. `user_settings` (ุงูุฅุนุฏุงุฏุงุช)
- **`user_id`**: ุงูููุชุงุญ ุงูุฃุณุงุณู.
- **`theme`**: ุงูุซูู ุงููุฎุชุงุฑ.
- **`language`**: ุงููุบุฉ (`ar`, `en`).
- **`calculation_method`**: ุทุฑููุฉ ุญุณุงุจ ุงูููุงููุช.
- **`madhab`**: ุงููุฐูุจ ุงููููู (ููุนุตุฑ).

### 6. `locations` (ุงููููุน)
- **`user_id`**: ุงูููุชุงุญ ุงูุฃุณุงุณู.
- **`latitude`, `longitude`**: ุงูุฅุญุฏุงุซูุงุช.
- **`name`**: ุงุณู ุงููุฏููุฉ.
- **`is_manual_mode`**: ูู ุชู ุชุญุฏูุฏ ุงููููุน ูุฏููุงูุ

---

## ๐ ุงูุงุชุตุงูุงุช ูุงูุนูุงูุงุช

1.  **Client-Server**: ูุชู ุงูุงุชุตุงู ุจู Supabase ูุจุงุดุฑุฉ ุนุจุฑ `supabaseClient.js` ุจุงุณุชุฎุฏุงู `REST API` ููุนูููุงุช ุงูุนุงุฏูุฉ ู `WebSockets` ูููุฒุงููุฉ ุงููุญุธูุฉ.
2.  **Relationships**:
    - ูู ุงูุฌุฏุงูู (`prayer_records`, `qada_prayers`, etc.) ูุฑุชุจุทุฉ ุจุฌุฏูู `profiles` ุนุจุฑ ุญูู `user_id`.
    - ูุชู ุชูุนูู ุณูุงุณุงุช ุงูุฃูุงู (RLS - Row Level Security) ูุถูุงู ุฃู ูู ูุณุชุฎุฏู ูุตู ูุจูุงูุงุชู ููุท.

---

## ๐ข ุงููุชุบูุฑุงุช ูุงูุซูุงุจุช (Variables & Constants)

- **`PRAYERS` (in `PrayerService`)**: ูุงุฆู ูุญุชูู ุนูู ุชุนุฑูู ุงูุตููุงุช (ุนุฏุฏ ุงูุฑูุนุงุชุ ุงูููุงุทุ ููู ูู ูุฑุถ ุฃู ุณูุฉ).
- **`RANKS` (in `PointsManager`)**: ูุตูููุฉ ุชุนุฑู ุงูุฑุชุจ (ุจุฑููุฒูุ ูุถูุ ุฐูุจู...) ูุงูุญุฏ ุงูุฃุฏูู ูู ุงูููุงุท ููู ุฑุชุจุฉ.
- **`THEMES`**: ูุนุฑูุฉ ูุฃุณูุงุก ููุงุณุงุช ูู CSS (ูุซู `.theme-midnight`, `.theme-emerald`).

---

## โ๏ธ ุงููุธุงุฆู ูุงูุนูููุงุช (Functions & Processes)

### ุฏูุฑุฉ ุญูุงุฉ ุงูุตูุงุฉ (Prayer Lifecycle)
1.  ูููู `PrayerManager` ุจุญุณุงุจ ุงูููุงููุช ุจูุงุกู ุนูู ุงููููุน ูุงูุชุงุฑูุฎ.
2.  ุนูุฏ ุฏุฎูู ุงูููุชุ ูุฑุณู `NotificationManager` ุฅุดุนุงุฑุงู.
3.  ุนูุฏูุง ูุคุฏู ุงููุณุชุฎุฏู ุงูุตูุงุฉุ ูุณุชุฏุนู `PrayerService.markPrayer`:
    - ูุชู ุญูุธ ุงูุณุฌู ูู `prayer_records`.
    - ูุชู ุฅุถุงูุฉ ููุงุท ุนุจุฑ `PointsService`.
    - ูุชู ุญุฐู ุฃู ูุถุงุก ูุฑุชุจุท (ุฅุฐุง ูุงู ููุฌูุฏุงู) ุนุจุฑ `removeQada`.
4.  ุฅุฐุง ุงูุชูู ุงูููุช ููู ุชูุตูููุ ูููู `PrayerManager` ุจุฅุถุงูุชูุง ุชููุงุฆูุงู ุฅูู `qada_prayers`.

### ูุธุงู ุงูููุงุท (Gamification)
- ุชุนูู ุฏุงูุฉ `addPoints` ูู `PointsService` ุนูู ุถูุงู ุนุฏู ุชูุฑุงุฑ ุงุญุชุณุงุจ ุงูููุงุท ูููุณ ุงูุนูููุฉ (Idempotency) ุจุงุณุชุฎุฏุงู ูุนุฑู ูุฑูุฏ ููู ุนูููุฉ (ูุซูุงู `user_id:date:prayer`).
- ูุชู ุชุญุฏูุซ ุฅุฌูุงูู ุงูููุงุท ุนุจุฑ `Realtime Subscription` ููุธูุฑ ููุฑุงู ูู ุงูู Header.

---
*ุชู ุงูุชุญุฏูุซ ุจุชุงุฑูุฎ: 2026-01-09*
